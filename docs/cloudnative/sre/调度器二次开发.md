# Kubernetes 调度器二次开发指南

调度器（kube-scheduler）是 Kubernetes 控制平面的核心组件，负责根据多维度策略将 Pod 绑定到合适节点。企业常见定制场景包括：调度算法优化、约束/亲和新语义、打分权重调整、自定义预选或优选插件等。

---

## 1. 核心架构与插件机制

K8s v1.19+ scheduler 支持基于 Framework 的插件式扩展，主要结构如下：

- **PreFilter**：预先过滤，常用于集群级资源/配额校验
- **Filter**：节点过滤，决定某节点是否可调度
- **Score**：节点打分，影响最终调度优先级
- **Reserve/Permit**：资源预留、分布式调度一致性场景
- **Bind**：定制绑定逻辑
- **PostBind/Unreserve**：后置hook/资源回滚

常用调度流程简图：

```
等待调度Pod --> PreFilter --> Filter(筛选可用Node) --> Score(打分排序) --> Bind
```

---

## 2. 二次开发入门：自定义调度插件

以 v1.24+ scheduler plugin 为例，流程如下：

1. **插件定义与注册**
   编写 Go 插件，实现一个或多个扩展点接口：

   ```go
   type MyScorePlugin struct{}

   func (pl *MyScorePlugin) Name() string { return "MyScore" }

   func (pl *MyScorePlugin) Score(ctx context.Context, state *framework.CycleState, pod *v1.Pod, nodeName string) (int32, *framework.Status) {
       // 打分逻辑：返回分值越高优先级越高
       return myScoreFunc(pod, nodeName), framework.NewStatus(framework.Success, "")
   }
   // 可选实现：ScoreExtensions
   ```

2. **编译与集成**
   - 修改 `cmd/kube-scheduler/app/plugins.go` 注册插件
   - 构建 scheduler 二进制镜像（可用 staging 或足够新版本原生支持）

3. **APIServer 注册/生效**
   - 用 `--config=scheduler-config.yaml` 启用自定义插件：

   ```yaml
   apiVersion: kubescheduler.config.k8s.io/v1
   kind: KubeSchedulerConfiguration
   profiles:
     - plugins:
         score:
           enabled:
             - name: MyScore
   ```

---

## 3. 典型扩展场景

- **自定义节点定位/容量调度**
  - 根据业务标签实现 antiaffinity、亲和智能打分
  - 结合 CRD 进行 quota/绑定-解绑策略

- **跨可用区容灾调度**  
  依据地理、机房属性做多维成本评估，降低单点风险

- **GPU/高性能资源定制**  
  原生 Filter/Score 钩子扩展 GPU Topology 感知与多 Pod 粒度公平分配

- **多租户调度限流**
  权重、优先级分配拦截，实现 Soft, Hard Quota 场景

---

## 4. 生产级开发建议

- 优先用内置插件组合（https://kubernetes.io/docs/concepts/scheduling-eviction/scheduling-framework/）大部分场景可用
- 定制化建议继承/组合官方库，利用 frameworkhandle 访问 informers/cache
- 调度插件需关注可复现性与性能开销，强烈建议单元与 e2e 测试
- 实现细致 metric/exporter 便于 trace 与性能监测

---

## 5. 参考资料与最佳实践

- [K8s 调度器官方扩展文档](https://kubernetes.io/docs/concepts/scheduling-eviction/scheduling-framework/)
- [scheduler plugin 源码示例](https://github.com/kubernetes-sigs/scheduler-plugins)
- [社区最佳实践分析](https://jimmysong.io/kubernetes-handbook/extend/scheduler.html)
- [K8s 多租户与调度最佳实践](https://cloudnative.to/blog/key-points-about-k8s-scheduler/)

---

> 总结：K8s 调度器 framework 已高度插件化，绝大多数场景可通过 Filter/Score/Bind 等钩子优雅扩展。建议优先原生插件优先，复杂业务结合 CRD / 事件灵活定制。配合 CI/CD、调度注解与 trace 工具，二次开发可安全高效上线。

如需 CRD 协同调度、多维资源 Score 核心代码案例、容灾/多租通用插件设计等进阶主题，欢迎留言讨论！
